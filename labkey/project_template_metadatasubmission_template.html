<form name="submissionMetadataForm">
   <table cellspacing="0" cellpadding="5" border="0">
       <tr>
           <td colspan="2">Please complete the form below to enter submission metadata.
               All starred fields are required.</td>
       </tr>
<tr><td colspan="2"><br/></td></tr>
       <tr>
           <td colspan="2"><div id="errorTxt" style="display:none;color:red"></div></td>
       </tr>
       <tr>
           <td valign="top" width="100"><strong>Requester:*</strong></td>
           <td valign="top"><input type="text" name="DisplayName" size="30"></td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="100"><strong>Project Name:*</strong></td>
           <td valign="top">
               <div>
                   <select id="proposalName" name="proposalName">
                       <option>Loading...</option>
                   </select>
               </div>
           </td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="200"><strong>Experiment Name:*</strong><p><i>Must be unique</i></p></td>
           <td valign="top"><input type="text" name="experimentName" size="30"></td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="200"><strong>Planned Submission Date:*</strong></td>
           <td valign="top"><input type="date" name="plannedSubmissionDate" size="30"></td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="200"><strong>Earliest Submission Date:*</strong></td>
           <td valign="top"><input type="date" name="earliestSubmissionDate" size="30"></td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="200"><strong>Latest Submission Date:*</strong></td>
           <td valign="top"><input type="date" name="latestSubmissionDate" size="30"></td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="100"><strong>Description:</strong></td>
           <td valign="top"><textarea cols="53" rows="5" name="description"></textarea></td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="100"><strong>Describe your hypotheses:</strong></td>
           <td valign="top"><textarea cols="53" rows="5" name="hypothesis"></textarea></td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="100"><strong>Metabolites of interest:</strong></td>
           <td valign="top"><textarea cols="53" rows="5" name="metabolitesOfInterest"></textarea></td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="200"><strong>Anticipated Number of Samples:*</strong></td>
           <td valign="top"><input type="number" min="0" step="1" name="anticipatedNumberOfSamples" size="30"></td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>

<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="100"><strong>Anticipated Task 1:*</strong></td>
           <td valign="top">
               <div>
                   <select id="anticipatedTask1" name="anticipatedTask1">
                       <option>Loading...</option>
                   </select>
               </div>
           </td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="100"><strong>Anticipated Task 2:*</strong></td>
           <td valign="top">
               <div>
                   <select id="anticipatedTask2" name="anticipatedTask2">
                       <option>Loading...</option>
                   </select>
               </div>
           </td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="100"><strong>Anticipated Task 3:*</strong></td>
           <td valign="top">
               <div>
                   <select id="anticipatedTask3" name="anticipatedTask3">
                       <option>Loading...</option>
                   </select>
               </div>
           </td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="100"><strong>Anticipated Task 4:*</strong></td>
           <td valign="top">
               <div>
                   <select id="anticipatedTask4" name="anticipatedTask4">
                       <option>Loading...</option>
                   </select>
               </div>
           </td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>
       <tr>
           <td valign="top" width="100"><strong>Anticipated Task 5:*</strong></td>
           <td valign="top">
               <div>
                   <select id="anticipatedTask5" name="anticipatedTask5">
                       <option>Loading...</option>
                   </select>
               </div>
           </td>
       </tr>
<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>

<tr><td colspan="2" style="line-height:.6em"><br/></td></tr>

        <tr>
           <td valign="top" colspan="2" valign="center">
           <input value='Submit' type='button' id='toggle' onclick='submitRequest()'>
	 </td>
       </tr>
   </table>
</form>

<script type="text/javascript">

    window.onload = init();

    // Initialize the form by populating the Projects drop-down list and
   // entering data associated with the current user.
   function init() {
       LABKEY.Query.selectRows({
           containerPath: 'Project Tracking',
	   schemaName: 'lists',
           queryName: 'proposal',
           success: populateProposal
       });

       LABKEY.Query.selectRows({
           containerPath: 'Project Tracking',
	   schemaName: 'lists',
           queryName: 'task',
           success: populateTask1
       });

       LABKEY.Query.selectRows({
           containerPath: 'Project Tracking',
	   schemaName: 'lists',
           queryName: 'task',
           success: populateTask2
       });

       LABKEY.Query.selectRows({
           containerPath: 'Project Tracking',
	   schemaName: 'lists',
           queryName: 'task',
           success: populateTask3
       });

       LABKEY.Query.selectRows({
           containerPath: 'Project Tracking',
	   schemaName: 'lists',
           queryName: 'task',
           success: populateTask4
       });

       LABKEY.Query.selectRows({
           containerPath: 'Project Tracking',
	   schemaName: 'lists',
           queryName: 'task',
           success: populateTask5
       });

        document.getElementById("proposalName").selectedIndex = 0;

        // Set the form values
       var submitForm = document.getElementsByName("submissionMetadataForm")[0];
       submissionMetadataForm.DisplayName.value = LABKEY.Security.currentUser.displayName;
   }

    // Populate the proposal drop-down menu with the results of
   // the call to LABKEY.Query.selectRows.
   function populateProposal(data) {
       var el = document.getElementById("proposalName");
       el.options[0].text = "<Select Project>";
       for (var i = 0; i < data.rows.length; i++) {
           var opt = document.createElement("option");
           opt.text = data.rows[i].name;
           opt.value = data.rows[i].name;
           el.options[el.options.length] = opt;
       }
   }

    // Populate the task1 drop-down menu with the results of
   // the call to LABKEY.Query.selectRows.
   function populateTask1(data) {
       var el = document.getElementById("anticipatedTask1");
       el.options[0].text = "<Select Task>";
       for (var i = 0; i < data.rows.length; i++) {
           var opt = document.createElement("option");
           opt.text = data.rows[i].name;
           opt.value = data.rows[i].name;
           el.options[el.options.length] = opt;
       }
   }

    // Populate the task2 drop-down menu with the results of
   // the call to LABKEY.Query.selectRows.
   function populateTask2(data) {
       var el = document.getElementById("anticipatedTask2");
       el.options[0].text = "<Select Task>";
       for (var i = 0; i < data.rows.length; i++) {
           var opt = document.createElement("option");
           opt.text = data.rows[i].name;
           opt.value = data.rows[i].name;
           el.options[el.options.length] = opt;
       }
   }

    // Populate the task3 drop-down menu with the results of
   // the call to LABKEY.Query.selectRows.
   function populateTask3(data) {
       var el = document.getElementById("anticipatedTask3");
       el.options[0].text = "<Select Task>";
       for (var i = 0; i < data.rows.length; i++) {
           var opt = document.createElement("option");
           opt.text = data.rows[i].name;
           opt.value = data.rows[i].name;
           el.options[el.options.length] = opt;
       }
   }

    // Populate the task4 drop-down menu with the results of
   // the call to LABKEY.Query.selectRows.
   function populateTask4(data) {
       var el = document.getElementById("anticipatedTask4");
       el.options[0].text = "<Select Task>";
       for (var i = 0; i < data.rows.length; i++) {
           var opt = document.createElement("option");
           opt.text = data.rows[i].name;
           opt.value = data.rows[i].name;
           el.options[el.options.length] = opt;
       }
   }

    // Populate the task5 drop-down menu with the results of
   // the call to LABKEY.Query.selectRows.
   function populateTask5(data) {
       var el = document.getElementById("anticipatedTask5");
       el.options[0].text = "<Select Task>";
       for (var i = 0; i < data.rows.length; i++) {
           var opt = document.createElement("option");
           opt.text = data.rows[i].name;
           opt.value = data.rows[i].name;
           el.options[el.options.length] = opt;
       }
   }

    // Enter form data into the submission list after validating

   function submitRequest() {
       // Make sure the form contains valid data
       if (!checkForm()) {
           return;
       }

        // Insert form data into the list.
       LABKEY.Query.insertRows({
           containerPath: 'Project Tracking',
	   schemaName: 'lists',
           queryName: 'experiment',
           rowDataArray: [{
	       "requester":  document.submissionMetadataForm.DisplayName.value,
               "project":  document.submissionMetadataForm.proposalName.value,
               "name": document.submissionMetadataForm.experimentName.value,
               "planned_submission_date": document.submissionMetadataForm.plannedSubmissionDate.value,
               "earliest_submission_date": document.submissionMetadataForm.earliestSubmissionDate.value,
               "latest_submission_date": document.submissionMetadataForm.latestSubmissionDate.value,
               "description": document.submissionMetadataForm.description.value,
               "hypothesis": document.submissionMetadataForm.hypothesis.value,
               "metabolites_of_interest": document.submissionMetadataForm.metabolitesOfInterest.value,
               "anticipated_num_samples": parseInt(document.submissionMetadataForm.anticipatedNumberOfSamples.value),
               "anticipated_task1": document.submissionMetadataForm.anticipatedTask1.value,
               "anticipated_task2": document.submissionMetadataForm.anticipatedTask2.value,
               "anticipated_task3": document.submissionMetadataForm.anticipatedTask3.value,
               "anticipated_task4": document.submissionMetadataForm.anticipatedTask4.value,
               "anticipated_task5": document.submissionMetadataForm.anticipatedTask5.value,

           }],
           success: function(data) {
           	console.log(data);
              	 window.location = "https://metabolomics.app.labkey.host/Project%20Tracking/Project%20Template/project-begin.view?pageId=Sample%20Upload";

		
           }
       });
   }

    // Check to make sure that the form contains valid data.  If not,
   // display an error message above the form listing the fields that need to be populated.
   function checkForm() {
       var result = true;
       var ob = document.submissionMetadataForm.proposalName;
       var err = document.getElementById("errorTxt");
       err.innerHTML = '';
       if(!result)
           document.getElementById("errorTxt").style.display = "block";
       return result;
   }
</script>